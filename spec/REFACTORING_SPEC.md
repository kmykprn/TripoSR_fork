# TripoSR run.py リファクタリング仕様書

## 現状の問題点

1. **モノリシック構造**
   - 200行以上のコードが単一ファイルに集中
   - 責務の分離が不十分

2. **責務の混在**
   - コマンドライン引数処理
   - 画像前処理
   - 3D推論処理
   - ファイルI/O処理
   - が全て1ファイルに混在

3. **グローバル変数の使用**
   - `timer`がグローバル変数として定義

4. **エラーハンドリング不足**
   - try-exceptブロックが存在しない
   - エラー時の適切な処理が未実装

5. **テスタビリティの低さ**
   - 単体テストが書きづらい構造
   - 各機能が密結合

## リファクタリング方針

### モジュール分割案

```
tsr_pipeline/
├── __init__.py
├── cli.py              # コマンドライン引数処理
├── config.py           # 設定管理
├── timer.py            # タイマーユーティリティ
├── preprocessing.py    # 画像前処理
├── inference.py        # 3D推論処理
├── export.py          # メッシュ・テクスチャ出力
├── rendering.py       # レンダリング処理
└── main.py            # メインエントリポイント
```

### 各モジュールの責務

#### 1. cli.py
- コマンドライン引数のパース
- 引数の検証
- 設定オブジェクトの生成

#### 2. config.py
- 設定値の管理
- デフォルト値の定義
- 設定の検証

#### 3. timer.py
- 処理時間計測
- GPU同期を考慮した時間計測
- ログ出力

#### 4. preprocessing.py
- 背景除去処理
- 画像リサイズ
- アルファチャンネル処理
- 前処理済み画像の保存

#### 5. inference.py
- TSRモデルのロード
- 画像から3Dシーンコードの生成
- モデル管理

#### 6. export.py
- メッシュ出力（OBJ/GLB）
- テクスチャベイキング
- UV座標生成
- ファイル保存処理

#### 7. rendering.py
- 多視点レンダリング
- 動画生成
- レンダリング画像の保存

#### 8. main.py
- 各モジュールの統合
- 処理フローの制御
- エラーハンドリング

### 実装優先順位

1. **Phase 1**: 基本的な分割
   - timer.pyの分離
   - config.pyの作成
   - cli.pyの分離

2. **Phase 2**: 処理の分離
   - preprocessing.pyの作成
   - inference.pyの作成
   - export.pyの作成

3. **Phase 3**: 追加機能の分離
   - rendering.pyの作成
   - main.pyの整理

4. **Phase 4**: テストとドキュメント
   - 単体テストの追加
   - ドキュメントの更新
   - エラーハンドリングの強化

### 期待される効果

1. **保守性の向上**
   - 各モジュールが独立して修正可能
   - 責務が明確で理解しやすい

2. **テスタビリティの向上**
   - 各モジュールを独立してテスト可能
   - モックを使用したテストが容易

3. **拡張性の向上**
   - 新機能の追加が容易
   - 既存機能への影響を最小化

4. **再利用性の向上**
   - 各モジュールを他のスクリプトから利用可能
   - APIとしての利用も可能

## 実装スケジュール（案）

- Phase 1: 1-2時間
- Phase 2: 2-3時間
- Phase 3: 1-2時間
- Phase 4: 2-3時間

合計: 6-10時間