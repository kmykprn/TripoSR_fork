# GLB形式でのテクスチャ付きメッシュ出力機能 - 要件定義書

## 1. 概要
TripoSRで生成した3Dメッシュを、GLB形式でUV座標付きメッシュとテクスチャ画像として出力する機能を実装する。これにより、react-three-fiberなどのフロントエンドフレームワークでメッシュとテクスチャを個別にロードして結合できるようになる。

## 2. 機能要件

### 2.1 基本要件
- `--model-save-format glb --bake-texture`オプションを指定した場合、以下のファイルを出力する：
  - `mesh.glb`: UV座標を含むGLB形式のメッシュファイル
  - `texture.png`: ベイクされたテクスチャ画像ファイル

### 2.2 出力仕様
- **GLBファイル**
  - UV座標が正しく設定されていること
  - 頂点、法線、面情報が含まれていること
  - テクスチャ画像への参照は含まない（別ファイルとして扱う）
  
- **テクスチャファイル**
  - PNG形式で出力
  - 解像度は`--texture-resolution`オプションで指定された値（デフォルト: 1024）
  - 既存のテクスチャベイキング処理結果を使用

### 2.3 互換性要件
- 既存のOBJ+テクスチャ出力機能は維持する
- `--model-save-format obj --bake-texture`の動作は変更しない
- テクスチャベイキングなしのGLB出力（頂点カラー）も維持する

### 2.4 エラーハンドリング
- GLB出力時にエラーが発生した場合、適切なエラーメッセージを表示
- ファイル出力失敗時は処理を中断し、部分的なファイルが残らないようにする

## 3. 非機能要件

### 3.1 パフォーマンス
- 既存のOBJ出力と同等の処理速度を維持
- メモリ使用量の大幅な増加を避ける

### 3.2 保守性
- コードの重複を最小限に抑える
- 既存のテクスチャベイキング処理を再利用する

## 4. 制約事項
- trimeshライブラリの機能を使用してGLB出力を実現
- xatlasによるUV展開結果を活用
- 既存のbake_texture関数の出力形式は変更しない

## 5. テスト要件

### 5.1 単体テスト
- GLB形式でUV座標付きメッシュが正しく出力されることを確認
- テクスチャ画像が正しく出力されることを確認
- ファイル拡張子が正しいことを確認

### 5.2 統合テスト
- `python run.py examples/chair.png --output-dir output/ --model-save-format glb --bake-texture`コマンドが正常に動作すること
- 出力されたGLBファイルがtrimeshで読み込み可能であること
- UV座標が正しく設定されていることを確認

### 5.3 回帰テスト
- OBJ形式の出力が影響を受けていないことを確認
- テクスチャベイキングなしのGLB出力が正常に動作することを確認

## 6. 成功基準
- GLB形式でUV座標付きメッシュとテクスチャ画像が別々に出力される
- フロントエンド（react-three-fiber）で両ファイルを読み込んで正しく表示できる
- 既存機能への影響がない